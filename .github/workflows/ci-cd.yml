name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-test-build:
    name: Lint, Test & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Build application
        run: npm run build

  migrate-production:
    name: Migrate Production Database
    runs-on: ubuntu-latest
    needs: lint-test-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run migrations
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: npm run db:migrate

  deploy-production:
    name: Deploy to Vercel (Production)
    runs-on: ubuntu-latest
    needs: migrate-production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          npm install -g vercel
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          vercel build --prod --token=$VERCEL_TOKEN
          vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN

  setup-preview-database:
    name: Setup Preview Database
    runs-on: ubuntu-latest
    needs: lint-test-build
    if: github.event_name == 'pull_request'
    outputs:
      database_url: ${{ steps.create-db.outputs.database_url }}
      auth_token: ${{ steps.create-db.outputs.auth_token }}
    steps:
      - name: Create Turso branch database
        id: create-db
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_API_TOKEN }}
          TURSO_ORG_NAME: ${{ secrets.TURSO_ORG_NAME }}
          TURSO_PRIMARY_DB_NAME: ${{ secrets.TURSO_PRIMARY_DB_NAME }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          DB_NAME="packing-list-pr-${PR_NUMBER}"

          # Create branch database via API
          RESPONSE=$(curl -X POST \
            "https://api.turso.tech/v1/organizations/${TURSO_ORG_NAME}/databases" \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"${DB_NAME}\",
              \"group\": \"default\",
              \"seed\": {
                \"type\": \"database\",
                \"name\": \"${TURSO_PRIMARY_DB_NAME}\"
              }
            }")

          # Extract database hostname
          DB_HOSTNAME=$(echo $RESPONSE | jq -r '.database.hostname')
          DATABASE_URL="libsql://${DB_HOSTNAME}"

          # Create 7-day auth token
          TOKEN_RESPONSE=$(curl -X POST \
            "https://api.turso.tech/v1/organizations/${TURSO_ORG_NAME}/databases/${DB_NAME}/auth/tokens" \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"expiration": "7d"}')

          AUTH_TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.jwt')

          echo "database_url=${DATABASE_URL}" >> $GITHUB_OUTPUT
          echo "auth_token=${AUTH_TOKEN}" >> $GITHUB_OUTPUT

  migrate-preview:
    name: Migrate Preview Database
    runs-on: ubuntu-latest
    needs: setup-preview-database
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run migrations
        env:
          TURSO_DATABASE_URL: ${{ needs.setup-preview-database.outputs.database_url }}
          TURSO_AUTH_TOKEN: ${{ needs.setup-preview-database.outputs.auth_token }}
        run: npm run db:migrate

  deploy-preview:
    name: Deploy to Vercel (Preview)
    runs-on: ubuntu-latest
    needs: [setup-preview-database, migrate-preview]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel Preview
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          TURSO_DATABASE_URL: ${{ needs.setup-preview-database.outputs.database_url }}
          TURSO_AUTH_TOKEN: ${{ needs.setup-preview-database.outputs.auth_token }}
        run: |
          npm install -g vercel
          vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
          vercel build --token=$VERCEL_TOKEN
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=$VERCEL_TOKEN \
            --env TURSO_DATABASE_URL="$TURSO_DATABASE_URL" \
            --env TURSO_AUTH_TOKEN="$TURSO_AUTH_TOKEN")
          echo "DEPLOYMENT_URL=${DEPLOYMENT_URL}" >> $GITHUB_ENV

      - name: Comment on PR
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_URL: ${{ env.DEPLOYMENT_URL }}
          DATABASE_URL: ${{ needs.setup-preview-database.outputs.database_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const deploymentUrl = process.env.DEPLOYMENT_URL;
            const databaseUrl = process.env.DATABASE_URL;

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Preview Deployment Ready!

              **Deployment URL:** ${deploymentUrl}
              **Database:** \`packing-list-pr-${prNumber}\` (branch database with 7-day credentials)
              **Database URL:** \`${databaseUrl}\`

              This preview environment has its own isolated database branched from production.`
            });

  cleanup-preview:
    name: Cleanup Preview Database
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    steps:
      - name: Delete Turso branch database
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_API_TOKEN }}
          TURSO_ORG_NAME: ${{ secrets.TURSO_ORG_NAME }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          DB_NAME="packing-list-pr-${PR_NUMBER}"

          curl -X DELETE \
            "https://api.turso.tech/v1/organizations/${TURSO_ORG_NAME}/databases/${DB_NAME}" \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}"

          echo "âœ… Deleted preview database: ${DB_NAME}"
